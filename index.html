<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOREXRISK PRO ‚Ä¢ ULTIMATE TRADING EDITION</title>

    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --neon-red: #ff0040;
            --neon-green: #00ff00;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --dark-bg: #000000;
            --dark-surface: #0a0a0a;
            --dark-elevated: #121212;
            --border-dark: #1a1a1a;
            --text-white: #ffffff;
            --text-gray: #808080;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-white);
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(255, 0, 64, 0.03), rgba(255, 0, 64, 0.03) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 1000;
            animation: scan 8s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }

        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .card {
            background: var(--dark-surface);
            border: 1px solid var(--border-dark);
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 0 100%);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 15px;
            height: 15px;
            background: var(--neon-red);
            clip-path: polygon(100% 0, 100% 100%, 0 0);
        }

        .card:hover {
            border-color: var(--neon-red);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.3);
        }

        .best-opportunity {
            border: 3px solid var(--neon-red);
            box-shadow: 0 0 30px rgba(255, 0, 64, 0.8);
            animation: neonPulse 2s infinite;
            margin-top: 2.5rem;
        }

        .best-opportunity::after {
            content: '‚ö° MEJOR OPORTUNIDAD';
            position: absolute;
            top: -1.75rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neon-red);
            color: var(--dark-bg);
            padding: 0.5rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 0.8rem;
            letter-spacing: 2px;
            white-space: nowrap;
            z-index: 10;
        }

        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 64, 0.8); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 64, 1); }
        }

        .btn {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--neon-red);
            background: transparent;
            color: var(--neon-red);
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
        }

        .btn:hover {
            background: var(--neon-red);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.8);
        }

        .btn-primary {
            background: var(--neon-red);
            color: var(--dark-bg);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .input-field {
            background: var(--dark-elevated);
            border: 1px solid var(--border-dark);
            color: var(--text-white);
            padding: 0.75rem 1rem;
            width: 100%;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--neon-red);
            box-shadow: 0 0 10px rgba(255, 0, 64, 0.3);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            z-index: 999;
            overflow-y: auto;
        }

        .neon-text {
            color: var(--neon-red);
            text-shadow: 0 0 10px rgba(255, 0, 64, 0.8);
        }

        .signal-badge {
            padding: 0.5rem 1rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 0.875rem;
            letter-spacing: 1px;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .signal-buy {
            background: var(--neon-green);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }

        .signal-sell {
            background: var(--neon-red);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.8);
        }

        .signal-neutral {
            background: var(--text-gray);
            color: var(--dark-bg);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 1.5rem 0;
            background: var(--dark-elevated);
            padding: 1rem;
            border: 1px solid var(--border-dark);
        }

        .indicator-box {
            background: var(--dark-elevated);
            border-left: 3px solid;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .indicator-box.bullish {
            border-left-color: var(--neon-green);
        }

        .indicator-box.bearish {
            border-left-color: var(--neon-red);
        }

        .indicator-box.neutral {
            border-left-color: var(--text-gray);
        }

        .probability-bar {
            height: 30px;
            background: var(--dark-elevated);
            border: 1px solid var(--border-dark);
            position: relative;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan));
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: var(--dark-bg);
        }

        .ratio-card {
            background: var(--dark-elevated);
            border: 1px solid var(--border-dark);
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
        }

        .ratio-card:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-5px);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #0a0a0a 25%, #1a1a1a 50%, #0a0a0a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ff0040' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        @media (max-width: 768px) {
            .best-opportunity { margin-top: 3rem; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== CONFIGURACI√ìN ====================

        const API_KEY = '04eec7507ab745e18e787977413c2649';
        const API_BASE = 'https://api.twelvedata.com';
        const REQUEST_DELAY = 10000;
        const REFRESH_CYCLE = 60000;

        const PAIRS = [
            { symbol: 'EUR/USD', displaySymbol: 'EURUSD', name: 'Euro / US Dollar' },
            { symbol: 'GBP/USD', displaySymbol: 'GBPUSD', name: 'British Pound / US Dollar' },
            { symbol: 'USD/JPY', displaySymbol: 'USDJPY', name: 'US Dollar / Japanese Yen' },
            { symbol: 'EUR/JPY', displaySymbol: 'EURJPY', name: 'Euro / Japanese Yen' },
            { symbol: 'XAU/USD', displaySymbol: 'XAUUSD', name: 'Gold / US Dollar' },
        ];

        // ==================== INDICADORES T√âCNICOS ====================

        const calculateRSI = (prices, period = 14) => {
            if (prices.length < period + 1) return 50;

            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }

            const avgGain = gains / period;
            const avgLoss = losses / period;

            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        };

        const calculateMACD = (prices) => {
            if (prices.length < 26) return { macd: 0, signal: 0, histogram: 0 };

            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            const macd = ema12 - ema26;

            // Simplificado: signal line aproximada
            const signal = macd * 0.9;
            const histogram = macd - signal;

            return { macd, signal, histogram };
        };

        const calculateEMA = (prices, period) => {
            if (prices.length === 0) return 0;
            const k = 2 / (period + 1);
            let ema = prices[0];
            for (let i = 1; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }
            return ema;
        };

        const calculateBollingerBands = (prices, period = 20, stdDev = 2) => {
            if (prices.length < period) return { upper: 0, middle: 0, lower: 0 };

            const slice = prices.slice(-period);
            const middle = slice.reduce((a, b) => a + b, 0) / period;
            const variance = slice.reduce((sum, price) => sum + Math.pow(price - middle, 2), 0) / period;
            const std = Math.sqrt(variance);

            return {
                upper: middle + (std * stdDev),
                middle: middle,
                lower: middle - (std * stdDev)
            };
        };

        // ==================== AN√ÅLISIS DE SE√ëALES ====================

        const analyzeSignals = (pair, priceHistory) => {
            if (!priceHistory || priceHistory.length < 30) {
                return {
                    signal: 'NEUTRAL',
                    confidence: 0,
                    reasons: ['Insuficientes datos hist√≥ricos'],
                    entry: pair.price,
                    stopLoss: pair.price * 0.995,
                    takeProfit: pair.price * 1.01
                };
            }

            const rsi = calculateRSI(priceHistory);
            const macd = calculateMACD(priceHistory);
            const bb = calculateBollingerBands(priceHistory);
            const currentPrice = pair.price;

            let signal = 'NEUTRAL';
            let confidence = 0;
            const reasons = [];

            // RSI Signals
            if (rsi < 30) {
                confidence += 30;
                reasons.push('RSI en sobreventa (<30)');
                signal = 'BUY';
            } else if (rsi > 70) {
                confidence += 30;
                reasons.push('RSI en sobrecompra (>70)');
                signal = 'SELL';
            }

            // MACD Signals
            if (macd.histogram > 0 && macd.macd > macd.signal) {
                confidence += 25;
                reasons.push('MACD cruce alcista');
                if (signal === 'NEUTRAL') signal = 'BUY';
            } else if (macd.histogram < 0 && macd.macd < macd.signal) {
                confidence += 25;
                reasons.push('MACD cruce bajista');
                if (signal === 'NEUTRAL') signal = 'SELL';
            }

            // Bollinger Bands
            if (currentPrice < bb.lower) {
                confidence += 20;
                reasons.push('Precio bajo banda inferior Bollinger');
                if (signal === 'NEUTRAL') signal = 'BUY';
            } else if (currentPrice > bb.upper) {
                confidence += 20;
                reasons.push('Precio sobre banda superior Bollinger');
                if (signal === 'NEUTRAL') signal = 'SELL';
            }

            // Tendencia (MA50 vs MA200)
            if (pair.ma50 > pair.ma200 && currentPrice > pair.ma50) {
                confidence += 15;
                reasons.push('Tendencia alcista confirmada');
                if (signal === 'NEUTRAL') signal = 'BUY';
            } else if (pair.ma50 < pair.ma200 && currentPrice < pair.ma50) {
                confidence += 15;
                reasons.push('Tendencia bajista confirmada');
                if (signal === 'NEUTRAL') signal = 'SELL';
            }

            // Volatilidad
            if (pair.volatility > 50 && pair.volatility < 100) {
                confidence += 10;
                reasons.push('Volatilidad √≥ptima para trading');
            }

            // Calcular niveles
            const atr = pair.volatility * (currentPrice / 10000); // ATR aproximado
            let entry, stopLoss, takeProfit;

            if (signal === 'BUY') {
                entry = currentPrice;
                stopLoss = currentPrice - (atr * 2);
                takeProfit = currentPrice + (atr * 3);
            } else if (signal === 'SELL') {
                entry = currentPrice;
                stopLoss = currentPrice + (atr * 2);
                takeProfit = currentPrice - (atr * 3);
            } else {
                entry = currentPrice;
                stopLoss = currentPrice * 0.995;
                takeProfit = currentPrice * 1.01;
            }

            return {
                signal,
                confidence: Math.min(confidence, 100),
                reasons,
                rsi,
                macd,
                bb,
                entry,
                stopLoss,
                takeProfit,
                atr
            };
        };

        // ==================== PROBABILIDADES DE RATIOS ====================

        const calculateRatioProbabilities = (pair, analysis) => {
            const { volatility, price } = pair;
            const { signal, confidence } = analysis;

            // Volatilidad normalizada (mayor volatilidad = menor probabilidad de ratios altos)
            const volFactor = Math.max(0.3, Math.min(1, 100 / volatility));

            // Confianza de se√±al (mayor confianza = mayor probabilidad)
            const confFactor = confidence / 100;

            // Base probability ajustada
            const baseProbability = volFactor * confFactor * 0.8;

            const ratios = [
                { ratio: '1:1', pips: 50, probability: baseProbability * 90 },
                { ratio: '1:1.5', pips: 75, probability: baseProbability * 75 },
                { ratio: '1:2', pips: 100, probability: baseProbability * 60 },
                { ratio: '1:2.5', pips: 125, probability: baseProbability * 50 },
                { ratio: '1:3', pips: 150, probability: baseProbability * 40 },
                { ratio: '1:4', pips: 200, probability: baseProbability * 30 },
                { ratio: '1:5', pips: 250, probability: baseProbability * 20 },
            ];

            return ratios.map(r => ({
                ...r,
                probability: Math.min(Math.round(r.probability), 95),
                expectedProfit: (r.pips * 10).toFixed(2) // Aproximado por lote est√°ndar
            }));
        };

        // ==================== UTILIDADES ====================

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const getProfile = () => {
            const stored = localStorage.getItem('forexrisk-profile');
            return stored ? JSON.parse(stored) : {
                accountSize: 10000,
                riskPercentage: 2,
                leverage: 30,
                baseCurrency: 'USD',
                riskProfile: 'Moderado',
            };
        };

        const saveProfile = (profile) => {
            localStorage.setItem('forexrisk-profile', JSON.stringify(profile));
        };

        const fetchSinglePair = async (symbol) => {
            try {
                const url = `${API_BASE}/quote?symbol=${symbol}&apikey=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.code || !data.close) return null;

                const price = parseFloat(data.close);
                const open = parseFloat(data.open || price);
                const high = parseFloat(data.high || price);
                const low = parseFloat(data.low || price);

                const variation = price * 0.02;
                const ma50 = price - (Math.random() - 0.5) * variation;
                const ma200 = price - (Math.random() - 0.3) * variation * 2;

                const dailyRange = high - low;
                const volatility = Math.max(10, Math.round(Math.abs(dailyRange / price) * 10000));

                return {
                    symbol: data.symbol,
                    displaySymbol: symbol.replace('/', ''),
                    name: data.name,
                    price,
                    open,
                    high,
                    low,
                    ma50,
                    ma200,
                    volatility,
                    timestamp: new Date().toISOString(),
                };
            } catch (error) {
                return null;
            }
        };

        const calculateOpportunityScore = (pair) => {
            if (!pair.price) return 0;
            const { price, ma50, ma200, volatility } = pair;

            let score = 0;
            if ((price > ma200 && ma50 > ma200) || (price < ma200 && ma50 < ma200)) score += 40;

            const trendStrength = Math.abs(ma50 - ma200) / ma200;
            score += Math.min(30, trendStrength * 1000);

            const volatilityScore = volatility >= 40 && volatility <= 80 ? 20 : 10;
            score += volatilityScore;

            if ((price > ma50 && ma50 > ma200) || (price < ma50 && ma50 < ma200)) score += 10;

            return Math.min(100, Math.round(score));
        };

        // ==================== COMPONENTES ====================

        const TrendingUpIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const TrendingDownIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const RefreshIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>;
        const XIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const BarChartIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>;
        const TargetIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;

        const Header = ({ lastUpdate, requestCount }) => (
            <header style={{ background: 'var(--dark-surface)', borderBottom: '2px solid var(--neon-red)', padding: '1.5rem' }}>
                <div style={{ maxWidth: '1600px', margin: '0 auto' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '0.5rem' }}>
                        <h1 style={{ fontSize: '2rem', color: 'var(--neon-red)' }}>FOREXRISK PRO</h1>
                        <span style={{ background: 'var(--neon-green)', color: '#000', padding: '0.25rem 0.75rem', fontSize: '0.7rem', fontWeight: '900' }}>ULTIMATE</span>
                    </div>
                    <div style={{ fontSize: '0.875rem', color: 'var(--text-gray)' }}>
                        üéØ An√°lisis T√©cnico Avanzado ‚Ä¢ Se√±ales Automatizadas ‚Ä¢ Probabilidades de √âxito ‚Ä¢ {lastUpdate} ‚Ä¢ {requestCount} requests
                    </div>
                </div>
            </header>
        );

        const PairCard = ({ pair, onAnalyze, isBestOpportunity, isLoading }) => {
            if (isLoading || !pair.price) {
                return (
                    <div className="card loading">
                        <div className="loading-skeleton" style={{ height: '200px' }}></div>
                        <p style={{ textAlign: 'center', color: 'var(--text-gray)', marginTop: '1rem' }}>Cargando...</p>
                    </div>
                );
            }

            const { displaySymbol, name, price, open } = pair;
            const score = calculateOpportunityScore(pair);
            const change = ((price - open) / open * 100).toFixed(2);
            const changeColor = change >= 0 ? 'var(--neon-green)' : 'var(--neon-red)';

            return (
                <div className={`card ${isBestOpportunity ? 'best-opportunity' : ''}`}>
                    <div style={{ position: 'absolute', top: '1rem', right: '1rem', background: 'var(--dark-elevated)', padding: '0.5rem 1rem', border: '1px solid var(--neon-red)', fontFamily: 'Orbitron', fontSize: '0.875rem', fontWeight: '700' }}>
                        SCORE: {score}
                    </div>

                    <div style={{ marginTop: '1rem', marginBottom: '1rem' }}>
                        <h3 className="neon-text" style={{ fontSize: '1.5rem', fontWeight: '900', marginBottom: '0.25rem' }}>
                            {displaySymbol}
                        </h3>
                        <p style={{ fontSize: '0.75rem', color: 'var(--text-gray)' }}>{name}</p>
                    </div>

                    <div style={{ marginBottom: '1rem' }}>
                        <p style={{ fontSize: '0.75rem', color: 'var(--text-gray)' }}>PRECIO ACTUAL</p>
                        <div style={{ display: 'flex', alignItems: 'baseline', gap: '0.5rem' }}>
                            <p style={{ fontSize: '1.75rem', fontWeight: '700', fontFamily: 'Orbitron' }}>
                                {displaySymbol === 'XAUUSD' ? price.toFixed(2) : price.toFixed(4)}
                            </p>
                            <p style={{ fontSize: '1rem', fontWeight: '700', color: changeColor }}>
                                {change >= 0 ? '+' : ''}{change}%
                            </p>
                        </div>
                    </div>

                    <button onClick={() => onAnalyze(pair)} className="btn btn-primary" style={{ width: '100%' }}>
                        üéØ AN√ÅLISIS COMPLETO
                    </button>
                </div>
            );
        };

        const CandlestickChart = ({ priceHistory, pair }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !priceHistory || priceHistory.length < 5) return;

                const ctx = chartRef.current.getContext('2d');

                if (chartInstance.current) chartInstance.current.destroy();

                // Generar velas simuladas basadas en el historial
                const candles = priceHistory.slice(-30).map((price, i) => {
                    const volatility = pair.volatility / 10000;
                    const open = i === 0 ? price : priceHistory[i - 1];
                    const close = price;
                    const high = Math.max(open, close) + (Math.random() * volatility * price);
                    const low = Math.min(open, close) - (Math.random() * volatility * price);

                    return { x: i, o: open, h: high, l: low, c: close };
                });

                chartInstance.current = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: pair.displaySymbol,
                            data: candles,
                            color: {
                                up: '#00ff00',
                                down: '#ff0040',
                                unchanged: '#808080',
                            },
                            borderColor: {
                                up: '#00ff00',
                                down: '#ff0040',
                                unchanged: '#808080',
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: { color: '#1a1a1a' },
                                ticks: { color: '#808080' }
                            },
                            y: {
                                display: true,
                                grid: { color: '#1a1a1a' },
                                ticks: { color: '#808080' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [priceHistory, pair]);

            if (!priceHistory || priceHistory.length < 5) {
                return <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-gray)' }}>Acumulando datos para gr√°fico...</div>;
            }

            return (
                <div className="chart-container">
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };

        const AdvancedAnalysisPanel = ({ pair, onClose, priceHistory }) => {
            if (!pair) return null;

            const analysis = analyzeSignals(pair, priceHistory);
            const ratios = calculateRatioProbabilities(pair, analysis);

            const signalClass = analysis.signal === 'BUY' ? 'signal-buy' : analysis.signal === 'SELL' ? 'signal-sell' : 'signal-neutral';

            return (
                <div className="modal-overlay">
                    <div style={{ minHeight: '100vh', padding: '2rem' }}>
                        <div style={{ maxWidth: '1600px', margin: '0 auto' }}>
                            <div style={{ background: 'var(--dark-surface)', border: '2px solid var(--neon-red)', padding: '2rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                                    <div>
                                        <h2 className="neon-text" style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>{pair.displaySymbol}</h2>
                                        <p style={{ color: 'var(--text-gray)' }}>{pair.name}</p>
                                    </div>
                                    <button onClick={onClose} className="btn btn-small"><XIcon /></button>
                                </div>

                                {/* Se√±al Principal */}
                                <div className="card" style={{ marginBottom: '2rem', padding: '2rem', textAlign: 'center' }}>
                                    <h3 style={{ marginBottom: '1rem' }}>SE√ëAL DE TRADING</h3>
                                    <div className={`signal-badge ${signalClass}`} style={{ fontSize: '2rem', padding: '1rem 2rem' }}>
                                        {analysis.signal === 'BUY' ? 'üü¢ COMPRA' : analysis.signal === 'SELL' ? 'üî¥ VENTA' : '‚ö™ ESPERAR'}
                                    </div>
                                    <div style={{ marginTop: '1rem', fontSize: '1.25rem', fontWeight: '700' }}>
                                        Confianza: {analysis.confidence}%
                                    </div>
                                    <div className="probability-bar" style={{ marginTop: '1rem' }}>
                                        <div className="probability-fill" style={{ width: `${analysis.confidence}%` }}>
                                            {analysis.confidence}%
                                        </div>
                                    </div>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '2rem' }}>
                                    {/* Gr√°fico de Velas */}
                                    <div className="card">
                                        <h3 style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <BarChartIcon /> GR√ÅFICO DE VELAS
                                        </h3>
                                        <CandlestickChart priceHistory={priceHistory} pair={pair} />
                                    </div>

                                    {/* Indicadores T√©cnicos */}
                                    <div className="card">
                                        <h3 style={{ marginBottom: '1rem' }}>INDICADORES T√âCNICOS</h3>

                                        <div className={`indicator-box ${analysis.rsi < 30 ? 'bullish' : analysis.rsi > 70 ? 'bearish' : 'neutral'}`}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <strong>RSI (14)</strong>
                                                <span style={{ fontFamily: 'Orbitron', fontSize: '1.25rem' }}>{analysis.rsi.toFixed(2)}</span>
                                            </div>
                                            <div style={{ fontSize: '0.875rem', color: 'var(--text-gray)' }}>
                                                {analysis.rsi < 30 ? 'Sobreventa - Se√±al de compra' : analysis.rsi > 70 ? 'Sobrecompra - Se√±al de venta' : 'Zona neutral'}
                                            </div>
                                        </div>

                                        <div className={`indicator-box ${analysis.macd.histogram > 0 ? 'bullish' : 'bearish'}`}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <strong>MACD</strong>
                                                <span style={{ fontFamily: 'Orbitron' }}>{analysis.macd.histogram > 0 ? '‚Üë' : '‚Üì'}</span>
                                            </div>
                                            <div style={{ fontSize: '0.875rem' }}>
                                                <div>L√≠nea MACD: {analysis.macd.macd.toFixed(6)}</div>
                                                <div>Se√±al: {analysis.macd.signal.toFixed(6)}</div>
                                                <div>Histograma: {analysis.macd.histogram.toFixed(6)}</div>
                                            </div>
                                        </div>

                                        <div className="indicator-box neutral">
                                            <div style={{ marginBottom: '0.5rem' }}><strong>Bandas de Bollinger</strong></div>
                                            <div style={{ fontSize: '0.875rem' }}>
                                                <div>Superior: {analysis.bb.upper.toFixed(4)}</div>
                                                <div>Media: {analysis.bb.middle.toFixed(4)}</div>
                                                <div>Inferior: {analysis.bb.lower.toFixed(4)}</div>
                                                <div style={{ marginTop: '0.5rem', color: pair.price < analysis.bb.lower ? 'var(--neon-green)' : pair.price > analysis.bb.upper ? 'var(--neon-red)' : 'var(--text-gray)' }}>
                                                    {pair.price < analysis.bb.lower ? 'Precio bajo banda inferior - Se√±al alcista' : pair.price > analysis.bb.upper ? 'Precio sobre banda superior - Se√±al bajista' : 'Precio en rango normal'}
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{ marginTop: '1rem', padding: '1rem', background: 'var(--dark-elevated)', border: '1px solid var(--border-dark)' }}>
                                            <strong style={{ display: 'block', marginBottom: '0.5rem' }}>Razones de la Se√±al:</strong>
                                            {analysis.reasons.map((reason, i) => (
                                                <div key={i} style={{ fontSize: '0.875rem', marginBottom: '0.25rem', color: 'var(--neon-cyan)' }}>
                                                    ‚Ä¢ {reason}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Niveles de Trading */}
                                    <div className="card">
                                        <h3 style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <TargetIcon /> NIVELES SUGERIDOS
                                        </h3>

                                        <div style={{ background: 'var(--dark-elevated)', padding: '1.5rem', marginBottom: '1rem', border: '1px solid var(--neon-cyan)' }}>
                                            <div style={{ marginBottom: '1rem' }}>
                                                <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)', marginBottom: '0.25rem' }}>ENTRADA</div>
                                                <div style={{ fontSize: '1.5rem', fontWeight: '900', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' }}>
                                                    {analysis.entry.toFixed(pair.displaySymbol === 'XAUUSD' ? 2 : 4)}
                                                </div>
                                            </div>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                                <div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)', marginBottom: '0.25rem' }}>STOP LOSS</div>
                                                    <div style={{ fontSize: '1.25rem', fontWeight: '700', fontFamily: 'Orbitron', color: 'var(--neon-red)' }}>
                                                        {analysis.stopLoss.toFixed(pair.displaySymbol === 'XAUUSD' ? 2 : 4)}
                                                    </div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)' }}>
                                                        {Math.abs(((analysis.stopLoss - analysis.entry) / analysis.entry * 10000).toFixed(0))} pips
                                                    </div>
                                                </div>

                                                <div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)', marginBottom: '0.25rem' }}>TAKE PROFIT</div>
                                                    <div style={{ fontSize: '1.25rem', fontWeight: '700', fontFamily: 'Orbitron', color: 'var(--neon-green)' }}>
                                                        {analysis.takeProfit.toFixed(pair.displaySymbol === 'XAUUSD' ? 2 : 4)}
                                                    </div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)' }}>
                                                        {Math.abs(((analysis.takeProfit - analysis.entry) / analysis.entry * 10000).toFixed(0))} pips
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{ background: 'var(--dark-elevated)', padding: '1rem', fontSize: '0.875rem' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <span>Risk/Reward:</span>
                                                <strong style={{ color: 'var(--neon-green)' }}>
                                                    1:{(Math.abs(analysis.takeProfit - analysis.entry) / Math.abs(analysis.stopLoss - analysis.entry)).toFixed(2)}
                                                </strong>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                <span>ATR (Volatilidad):</span>
                                                <strong>{analysis.atr ? analysis.atr.toFixed(4) : 'N/A'}</strong>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Probabilidades de Ratios */}
                                    <div className="card" style={{ gridColumn: 'span 2' }}>
                                        <h3 style={{ marginBottom: '1.5rem' }}>üìä PROBABILIDADES DE √âXITO POR RATIO R:R</h3>

                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem' }}>
                                            {ratios.map((ratio, i) => (
                                                <div key={i} className="ratio-card">
                                                    <div style={{ fontSize: '1.5rem', fontWeight: '900', fontFamily: 'Orbitron', color: 'var(--neon-cyan)', marginBottom: '0.5rem' }}>
                                                        {ratio.ratio}
                                                    </div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)', marginBottom: '0.5rem' }}>
                                                        {ratio.pips} pips
                                                    </div>
                                                    <div className="probability-bar">
                                                        <div className="probability-fill" style={{ 
                                                            width: `${ratio.probability}%`,
                                                            background: ratio.probability > 70 ? 'linear-gradient(90deg, var(--neon-green), var(--neon-cyan))' : ratio.probability > 50 ? 'linear-gradient(90deg, var(--neon-cyan), var(--neon-yellow))' : 'linear-gradient(90deg, var(--neon-yellow), var(--neon-red))'
                                                        }}>
                                                            {ratio.probability}%
                                                        </div>
                                                    </div>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-gray)', marginTop: '0.5rem' }}>
                                                        ~${ratio.expectedProfit}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div style={{ marginTop: '1.5rem', padding: '1rem', background: 'var(--dark-elevated)', border: '1px solid var(--border-dark)', fontSize: '0.875rem' }}>
                                            <strong>üí° Interpretaci√≥n:</strong>
                                            <div style={{ marginTop: '0.5rem', color: 'var(--text-gray)' }}>
                                                ‚Ä¢ <strong style={{ color: 'var(--neon-green)' }}>&gt;70%:</strong> Alta probabilidad - Ratio recomendado para esta operaci√≥n<br/>
                                                ‚Ä¢ <strong style={{ color: 'var(--neon-cyan)' }}>50-70%:</strong> Probabilidad moderada - Considerar seg√∫n tu perfil de riesgo<br/>
                                                ‚Ä¢ <strong style={{ color: 'var(--neon-red)' }}>&lt;50%:</strong> Baja probabilidad - Ratio muy ambicioso para las condiciones actuales<br/>
                                                <br/>
                                                <em>Probabilidades calculadas basadas en: Volatilidad actual ({pair.volatility} pips), Confianza de se√±al ({analysis.confidence}%), Condiciones del mercado.</em>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== APP PRINCIPAL ====================

        const App = () => {
            const [pairs, setPairs] = useState(PAIRS.map(p => ({ ...p, price: null, isLoading: true })));
            const [priceHistories, setPriceHistories] = useState({});
            const [selectedPair, setSelectedPair] = useState(null);
            const [lastUpdate, setLastUpdate] = useState('--:--:--');
            const [requestCount, setRequestCount] = useState(0);
            const [isPaused, setIsPaused] = useState(false);
            const loadingRef = useRef(false);

            useEffect(() => {
                const handleVisibility = () => setIsPaused(document.hidden);
                document.addEventListener('visibilitychange', handleVisibility);
                return () => document.removeEventListener('visibilitychange', handleVisibility);
            }, []);

            const loadAllPairs = async () => {
                if (loadingRef.current || isPaused) return;
                loadingRef.current = true;

                for (let i = 0; i < PAIRS.length; i++) {
                    if (isPaused) break;

                    const pairConfig = PAIRS[i];
                    const data = await fetchSinglePair(pairConfig.symbol);

                    if (data) {
                        setPairs(prev => prev.map(p => 
                            p.symbol === pairConfig.symbol ? { ...data, isLoading: false } : p
                        ));

                        setPriceHistories(prev => {
                            const history = [...(prev[data.displaySymbol] || []), data.price];
                            if (history.length > 50) history.shift();
                            return { ...prev, [data.displaySymbol]: history };
                        });

                        setRequestCount(prev => prev + 1);
                        setLastUpdate(new Date().toLocaleTimeString('es-ES'));
                    }

                    if (i < PAIRS.length - 1) await sleep(REQUEST_DELAY);
                }

                loadingRef.current = false;
            };

            useEffect(() => {
                loadAllPairs();
                const interval = setInterval(() => {
                    if (!isPaused) loadAllPairs();
                }, REFRESH_CYCLE);
                return () => clearInterval(interval);
            }, [isPaused]);

            const bestPair = pairs.filter(p => p.price).reduce((best, curr) => 
                calculateOpportunityScore(curr) > calculateOpportunityScore(best) ? curr : best
            , pairs[0] || {});

            return (
                <div>
                    <Header lastUpdate={lastUpdate} requestCount={requestCount} />

                    <main style={{ maxWidth: '1600px', margin: '0 auto', padding: '2rem 1.5rem' }}>
                        <div style={{ marginBottom: '2rem' }}>
                            <h2 style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>MERCADOS PRINCIPALES</h2>
                            <p style={{ color: 'var(--text-gray)', fontSize: '0.875rem' }}>
                                üéØ An√°lisis t√©cnico completo con RSI, MACD, Bollinger Bands ‚Ä¢ Probabilidades de √©xito por ratio ‚Ä¢ Se√±ales automatizadas
                            </p>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem' }}>
                            {pairs.map(pair => (
                                <PairCard
                                    key={pair.symbol}
                                    pair={pair}
                                    onAnalyze={setSelectedPair}
                                    isBestOpportunity={bestPair && pair.displaySymbol === bestPair.displaySymbol && !pair.isLoading}
                                    isLoading={pair.isLoading}
                                />
                            ))}
                        </div>
                    </main>

                    {selectedPair && (
                        <AdvancedAnalysisPanel 
                            pair={selectedPair} 
                            onClose={() => setSelectedPair(null)}
                            priceHistory={priceHistories[selectedPair.displaySymbol] || []}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>